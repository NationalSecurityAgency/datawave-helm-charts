####################################
# Core Helm Template Configuration #
####################################

apiVersion: apps/v1
kind: StatefulSet

######################################
# Basic Metadata for this Deployment #
######################################

metadata:
  name: "{{ .Values.meta.name }}"
  labels:
    application: "{{ .Values.meta.name }}"

#####################################
# Complete Deployment Specification #
#####################################

spec:

  ######################################
  # Replication / Update Configuration #
  ######################################
  serviceName: "{{ .Values.meta.name }}"
  replicas: {{ .Values.replication.replicaCount }}
  revisionHistoryLimit: {{ .Values.replication.revisionHistoryLimit }}
  
  ###################################
  # Resource Selector Configuration #
  ###################################

  selector:
    matchLabels:
      application: "{{ .Values.meta.name }}"
  
  #####################################
  # Deployment Template Configuration #
  #####################################

  template:

    ##################################################
    # Basic Metadata for this Deployment's Resources #
    ##################################################

    metadata:
      labels:
        application: "{{ .Values.meta.name }}"

    #######################################
    # Deployment Resources Specifications #
    #######################################

    spec:
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.image.pullSecrets }}
      imagePullSecrets:
      {{- range . }}
      - name: {{ . }}
      {{- end }}
      {{- end }}
      securityContext:
        runAsUser: {{ .Values.global.security.userid | int64 }}
        fsGroup: {{ .Values.global.security.fsgroupid | int64 }}
      restartPolicy: "{{ .Values.restartPolicy }}"
      ##############################################
      # Containers Associated with this Deployment #
      ##############################################

      containers:
        - name: "{{ .Values.meta.name }}"
          image: "{{ .Values.image.name }}:{{ .Values.image.tag }}"
          imagePullPolicy: "{{ .Values.image.pullPolicy }}"
          resources: {}
          env:
            - name: KAFKA_CFG_NODE_ID
              value: "1"
            - name: KAFKA_CFG_PROCESS_ROLES
              value: controller,broker
            - name: ALLOW_PLAINTEXT_LISTENER
              value: "yes"
            - name: KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP
              value: CLIENT:PLAINTEXT,CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT
            - name: KAFKA_CFG_LISTENERS
              value: CLIENT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
            - name: KAFKA_CFG_MAX_REQUEST_SIZE
              value: "10485880"
            - name: KAFKA_CFG_ADVERTISED_LISTENERS
              value: CLIENT://{{ .Values.meta.name }}:9092,EXTERNAL://{{ .Values.meta.name }}-0:9094
            - name: KAFKA_CFG_CONTROLLER_QUORUM_VOTERS
              value: 1@{{ .Values.meta.name }}:9093
            - name: KAFKA_CFG_CONTROLLER_LISTENER_NAMES
              value: CONTROLLER
            - name: KAFKA_INTER_BROKER_LISTENER_NAME
              value: CLIENT
            - name: KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE
              value: "false"
            - name: KAFKA_CFG_DELETE_TOPICS_ENABLE
              value: "true"
